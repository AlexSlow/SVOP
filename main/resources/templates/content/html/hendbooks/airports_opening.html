<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta http-equiv="Content-type" Content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>
Аэропорты
</title>
	<link rel="stylesheet" href="/bootstrap/css/bootstrap.css" >
</head>
<Body>


<div id="header" th:insert="/content/html/nmenu.html"></div>


 <div id="content" class="container-fluid">
 
 
 
        <div class="row" >
        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12 col-xl-12">
		<div id="filter"  th:insert="/content/html/filter.html">
		
		</div>
		<h2 class="text-center" th:text="#{airports.title_tab}">Таблица аэропортов</h2>
		
<div class="table-responsive">
<table class="table table-striped table-bordered mb-5" id="content_table">
<thead>
<tr> <th name="id"></th><th  name="NameRu" data-type="text" th:text="#{airports.name_ru}">Название(RU)</th>
  <th name="NameEng" data-type="text" th:text="#{airports.name_eng}">Название(EN)</th> 
  <th name="NameCh" data-type="text" th:text="#{airports.name_ch}" >Название(CH)</th>
  <th name="GMT" data-type="text" th:text="#{airports.gmt_time}" >Отклонение метного времени по Гринвичу</th>
  <th name="ICAO" data-type="text" >ICAO</th>
  <th name="IATA" data-type="text" >IATA</th></tr>
</thead >
<tbody id="filter_table">
<tr th:each="airport : ${airports}">

<td  ><input type="checkbox" th:id="ch+${airport.id}" th:value="${airport.id}" name="ch[]" form="form"></td>
<td><label th:for="ch+${airport.id}" th:text="${airport.NameRu}"> </label></td>
<td><label th:for="ch+${airport.id}" th:text="${airport.NameEng}"> </label></td>
<td><label th:for="ch+${airport.id}" th:text="${airport.NameCh}"> </label></td>
<td><label th:for="ch+${airport.id}" th:text="${airport.GMT}"> </label></td>
<td><label th:for="ch+${airport.id}" th:text="${airport.ICAO}"> </label></td>
<td><label th:for="ch+${airport.id}" th:text="${airport.IATA}"> </label></td>
</tr>
<tr >
<td colspan="7" style="text-align:left;">  <input type='checkbox' 
id="maincheck"> <label for="maincheck" th:text="#{buttons.fire_all}"> Выделить все </label></td>
</tr>
</tbody>
</table>
</div>

</div>


<form action="" method="POST" id="form" role="form" >
<div class="btn-group fixed-bottom w-75 m-auto">


 <input type="button" name="add" data-toggle="modal" data-target="#addModal" data-content="add" th:value="#{buttons.add_bt}" 
 class="btn btn-primary"  />
 <input type="button" name="redact" data-content="redact" th:value="#{buttons.red_bt}"  data-toggle="modal" data-target="#addModal" 
 class="btn btn-warning"/>
 <input type="submit" name="delete" th:value="#{buttons.del_bt}" 
 class="btn btn-danger" formaction="http://localhost:8080/svop/airports/delete"/>
 </div>
 
 
</form>

</div>
 </div>

 
 
 
   
   
   
 
<script src="/js/jquery/jquery-3.3.1.min.js"></script>
<script src="/bootstrap/js/popper_min.js" ></script>
<script src="/bootstrap/js/bootstrap.min.js"></script>
<script src="/js/fire_check.js"></script>
<script src="/js/filter.js"></script>




<div id="addModal" class="modal fade" tabindex="-1">
 <div class="modal-dialog modal-lg">
 <div class="modal-content">
 <div class="modal-header">
 
 <h4 id="modal_title"></h4>
 </div>
 
	<div class="modal-body">
	<div class="table-responsive">
	<table class="table  mb-5" id="modal_table">
	<thead><tr></tr></thead>
	<tbody></tbody>
	</table>
	</div>
	</div>
 
 <div class="modal-footer">
 
 <div id="content" class="container-fluid">
        <div class="row mb-3 d-none" id="add_buttons">
<div class="col"></div>
<div class="col">
 <button id="add_str" class="btn-info">добавить строку</button>
 <button id="remove_str" class="btn-warning">убрать строку</button>
</div>
 </div>
 <div class="row">
 <div class="col"></div>
<div class="col">
  <button id="save" class="btn-success">Применить</button>
 <button class="btn-danger" data-dismiss="modal">закрыть</button>
 </div>
 </div>

 
 </div>
 </div>
 </div>
</div>  
 </div>
  <script th:inline="javascript">
 var Headers = new Map();  
 var Names = new Map(); 
 var content;
 $('#addModal').on('show.bs.modal', function (event) {

 clean();
  // получить кнопку, которая его открыло
  var button = $(event.relatedTarget)

  // извлечь информацию из атрибута data-content
   content= button.data('content') 
  // вывести колонки таблицы
  $("#modal_table thead").append("<tr></tr>");
  $("#content_table thead tr").children("th").each(function(){
  if ($(this).text()!="")
  {
  Headers.set($(this).text(),$(this).attr('data-type'));
  Names.set($(this).text(),$(this).attr('name'));
$("#modal_table thead tr").append("<th>"+$(this).text()+"</th>");
}
  
  });
  
  //console.log(Headers);
  if (content=="add")
  {
  $("#modal_title").text([[#{modal.header_add}]]);
  $("#add_buttons").removeClass("d-none");
  
   $("#modal_table tbody ").append("<tr></tr>");
   //console.log(Headers);
	for (let key of Headers.keys()) {
	let val=Headers.get(key);
	let name=Names.get(key);
	$("#modal_table tbody tr:last-child").append("<td>"+"<input class='control-sm'  name='"+name+"'  type='"+val+"'+  /></td>");
}
  }
  
  
  
  
  else
  {
  //Добавим колонку под id
   $("#modal_table thead tr ").prepend("<th></th>");
   $("#modal_title").text([[#{modal.header_red}]]);
   $("#add_buttons").addClass("d-none");
   
   //Выбор строк для редактирования
    $("#content_table tbody tr").each(function(){
	if ($(this).children("td:first-child").children("input").prop('checked')) //Если строка выбрана
	{
	let id=$(this).children("td:first-child").children("input").val();
	let data=[];
	
	$(this).children("td").each(function(){
	
	
$(this).children("label").each(function(){
	//Получение полей
	data.push($(this).text());
	});
	});
	//Вставим строку
	 $("#modal_table tbody ").append("<tr></tr>");
	 $("#modal_table tbody tr:last-child ").append("<td>"+"<input class='control-sm d-none' value='"+id+"' type='text'/></td>");
	 let i=0;
	for (let key of Headers.keys()) {
	let name=Names.get(key);
	let val=Headers.get(key);
	let input_value=data[i];
	$("#modal_table tbody tr:last-child").append("<td>"+"<input class='control-sm' name='"+name+"' value='"+input_value+"' type='"+val+"'/></td>");
	i++;
	  }
 }
 });
   
   
  }//конец else
   });
  
  
    //Добавить строку
   $("#add_str").on('click', function(e) {
   
   $("#modal_table tbody ").append("<tr></tr>");
   
   //console.log(Headers);
	for (let key of Headers.keys()) {
	let val=Headers.get(key);
	let name=Names.get(key);
	$("#modal_table tbody tr:last-child").append("<td>"+"<input class='control-sm'  name='"+name+"'  type='"+val+"'+  /></td>");

}
   });
   
    //Удалить строку
   $("#remove_str").on('click', function(e) {
   $("#modal_table tbody tr:last-child").remove();

   });
   
   
   //Сохраняем в массив объектов
    $("#save").on('click', function(e) {
	var ajax_array =[]

    $("#modal_table tbody tr").each(function(){
	let ajax_object ={}
	$(this).children("td").each(function(){
	//Индекс столбца и инодекс поля

	//let collumn=$("#modal_table thead tr").children("th").eq($(this).index()).attr('name');
	let collumn=$(this).children("input").attr('name');
	if (collumn==null) collumn="id";

	ajax_object[collumn]=$(this).children("input").val();
	//console.log(collumn);
	});
	//console.log(ajax_object);
	ajax_array.push(ajax_object);
	});
	//Мы получили объект запроса
	//console.log(ajax_array);
	if (content=="add")
	{
	send_add_request(ajax_array);
	}
	else{
	send_update_request(ajax_array);
	}
   });
   
   
   function clean()
   {
   $("#modal_table tbody").empty();
    $("#modal_table thead").empty();
   Headers.clear();
   Names.clear();
   //ajax_array.clear();

   }
   
   
  function send_add_request(ajax_array)
  {

	ajax_array.forEach(function(item, i, arr) {
  $.post("http://localhost:8080/svop/airports/add",{NameRu:item["NameRu"]
  ,NameEng:item["NameEng"],
  NameCh:item["NameCh"],
  GMT:item["GMT"],
  ICAO:item["ICAO"],
  IATA:item["IATA"]});
  
  console.log(item);
});
	$('#addModal').modal('hide');
   }
   function send_update_request(ajax_array)
  {
 	 ajax_array.forEach(function(item, i, arr) {
  $.post("http://localhost:8080/svop/airports/update",{id:item["id"],NameRu:item["NameRu"]
  ,NameEng:item["NameEng"],
  NameCh:item["NameCh"],
  GMT:item["GMT"],
  ICAO:item["ICAO"],
  IATA:item["IATA"]});
  
  //console.log(item);
});
$('#addModal').modal('hide');
   }

 
 </script> 


 
</Body>
</html>
<script>
</script>



